# Build firmware on push and PR
name: Build Firmware

on:
  push:
    branches: ["main"]
    paths:
      - 'src/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: ["main"]
    paths:
      - 'src/**'
  workflow_dispatch:

jobs:
  build-pico:
    name: Build Pico Firmware
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ARM GCC Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake

      - name: Clone Pico SDK
        run: |
          git clone https://github.com/raspberrypi/pico-sdk.git ~/pico-sdk
          cd ~/pico-sdk
          git submodule update --init

      - name: Build All Machine Types
        env:
          PICO_SDK_PATH: ~/pico-sdk
        run: |
          cd src/pico
          mkdir build && cd build
          cmake -DBUILD_ALL_MACHINES=ON ..
          make -j$(nproc)

      - name: Upload Pico Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pico-firmware
          path: |
            src/pico/build/*.uf2
          retention-days: 30

  build-esp32:
    name: Build ESP32 Firmware
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          pip install platformio

      - name: Build ESP32 Firmware
        run: |
          cd src/esp32
          pio run

      - name: Upload ESP32 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32-firmware
          path: |
            src/esp32/.pio/build/esp32s3/firmware.bin
            src/esp32/.pio/build/esp32s3/firmware.elf
          retention-days: 30

